#!/usr/bin/perl

# ################################################################################################################################################################################################################
# cluster_cell_types_in_bed_file.pl
#
# CC-BY Lee Edsall
#	email: edsall57@gmail.com
#	Twitter: @LeeEdsall
#
# This script was used to analyze data for Edsall et al. 2019 which compared DNase-seq data from 5 primates (human, chimpanzee, gorilla, orangutan, macaque)
#
# Cluster the cells / tissues from the Thurman et al 125 types using the ENCODE controlled vocabulary
# 	This is hardcoded for the files downloaded from http://hgdownload.cse.ucsc.edu/goldenpath/hg19/encodeDCC/wgEncodeAwgDnaseMasterSites/
#	Tissue type manually added using the "Tissue" column from https://genome.ucsc.edu/ENCODE/cellTypes.html
#	Cancer cell types not included in this script
#
# 	Tissue			Cell line index (from 0-124)
# 	ESC			33, 46, 122
# 	IPS			83
# 	blastula		80
# 	blood			7, 14, 15, 22, 23, 24, 25, 27, 28, 29, 30, 31, 32, 123, 124
# 	blood_vessel		8, 9, 38, 54, 55, 56, 57, 58, 59, 60, 61, 63, 64, 73
# 	bone			102
# 	brain			96
# 	brain_hippocampus	36
# 	breast			52
# 	cerebellar		35
# 	connective		74
# 	embryonic_lung		120, 121
# 	epithelium		34, 42, 45, 50, 62, 66, 67, 68, 70, 106, 109, 111
# 	eye			44
# 	fetal_membrane		17
# 	foreskin		47, 48
# 	gingiva			5, 49
# 	heart			39, 40, 41
# 	kidney			69
# 	liver			78, 81, 82, 115
# 	lung			3, 65, 100
# 	mammary			53
# 	monocytes		13
# 	muscle			19, 71, 72, 114
# 	myometrium		94
# 	pancreas		104, 105
# 	pancreatic_duct		79
# 	prostate		107, 110
# 	skin			2, 4, 6, 11, 20, 21, 93, 97, 98, 99, 108
# 	spinal_cord		37
# 	urothelium		117, 118
# 	uterus			84, 85
#
# The input bed file lists the cell types in the last column
# In the output bed file, put the tissue type instead
#
# Input bed file format
#	chr1	10440	10590	4	371	36.37	4	10,46,86,95,
# 	Column 1	chromosome
# 	Column 2	start
#	Column 3	end
#	Column 4	number of cell types
#	Column 5	?
#	Column 6	?
#	Column 7	number of cell types
#	Column 8	cell type index (from 0 to 124); each index is followed by a comma
#
# Creating the output file
# 	Column 1	chromosome			print as is
# 	Column 2	start				print as is
#	Column 3	end				print as is
#	Column 4	number of cell types		re-calculate
#	Column 5	?				print as is
#	Column 6	?				print as is
#	Column 7	number of cell types		re-calculate
#	Column 8	cell type index			change to names of tissues; each tissue is followed by a comma
#
# Print to the output file only if the score is above 0
#
# 2 input parameters
#	1. name of input file
#	2. name of output file
# ################################################################################################################################################################################################################

use strict;
use warnings;

my $input_file_name;
my $output_file_name;

my @line_array;
my $line;

my $cell_index_string;
my $score;
my $tissue_string;

my $line_counter = 0;
my $output_counter = 0;

unless (scalar @ARGV == 2)
{
        print STDERR "Usage: $0: \n\tparameter 1: name of input file\n\tparameter 2: name of output file\n";
        exit(0);
}

$input_file_name = $ARGV[0];
$output_file_name = $ARGV[1];

# =======================================================================================================================================
# Open files
# =======================================================================================================================================

open (INPUT_FILE, "<$input_file_name") or die "couldn't open input file $input_file_name\n";

open (OUTPUT_FILE, ">$output_file_name") or die "couldn't open output file $output_file_name\n";

# =======================================================================================================================================
# Process bed file
# =======================================================================================================================================

print STDOUT "Process bed file ($input_file_name)\n";

while ($line = <INPUT_FILE>)
{
	$line_counter++;

	chomp($line);
	@line_array = split(/\t/,$line);

	$score = 0;
	$tissue_string = ",";

	# Need to add a comma to the beginning of the cell-type string to make the match work correctly
	$cell_index_string = "," . $line_array[7]; 

# ---------------------------------------------------------------------------------------------------------------------------------------
# ESC
# ---------------------------------------------------------------------------------------------------------------------------------------

	if ($cell_index_string =~ /,33,|,46,|,122,/)
	{
		$score++;
		$tissue_string .= "ESC,";
	}

# ---------------------------------------------------------------------------------------------------------------------------------------
# IPS
# ---------------------------------------------------------------------------------------------------------------------------------------

	if ($cell_index_string =~ /,83,/)
	{
		$score++;
		$tissue_string .= "IPS,";
	}

# ---------------------------------------------------------------------------------------------------------------------------------------
# blastula
# ---------------------------------------------------------------------------------------------------------------------------------------

	if ($cell_index_string =~ /,80,/)
	{
		$score++;
		$tissue_string .= "blastula,";
	}


# ---------------------------------------------------------------------------------------------------------------------------------------
# blood
# ---------------------------------------------------------------------------------------------------------------------------------------

	if ($cell_index_string =~ /,7,|,14,|,15,|,22,|,23,|,24,|,25,|,27,|,28,|,29,|,30,|,31,|,32,|,123,|,124,/)
	{
		$score++;
		$tissue_string .= "blood,";
	}

# ---------------------------------------------------------------------------------------------------------------------------------------
# blood vessel
# ---------------------------------------------------------------------------------------------------------------------------------------

	if ($cell_index_string =~ /,8,|,9,|,38,|,54,|,55,|,56,|,57,|,58,|,59,|,60,|,61,|,63,|,64,|,73,/)
	{
		$score++;
		$tissue_string .= "blood_vessel,";
	}

# ---------------------------------------------------------------------------------------------------------------------------------------
# bone
# ---------------------------------------------------------------------------------------------------------------------------------------

	if ($cell_index_string =~ /,102,/)
	{
		$score++;
		$tissue_string .= "bone,";
	}

# ---------------------------------------------------------------------------------------------------------------------------------------
# brain
# ---------------------------------------------------------------------------------------------------------------------------------------

	if ($cell_index_string =~ /,96,/)
	{
		$score++;
		$tissue_string .= "brain,";
	}

# ---------------------------------------------------------------------------------------------------------------------------------------
# brain hippocampus
# ---------------------------------------------------------------------------------------------------------------------------------------

	if ($cell_index_string =~ /,36,/)
	{
		$score++;
		$tissue_string .= "brain_hippocampus,";
	}

# ---------------------------------------------------------------------------------------------------------------------------------------
# breast
# ---------------------------------------------------------------------------------------------------------------------------------------

	if ($cell_index_string =~ /,52,/)
	{
		$score++;
		$tissue_string .= "breast,";
	}

# ---------------------------------------------------------------------------------------------------------------------------------------
# cerebellar
# ---------------------------------------------------------------------------------------------------------------------------------------

	if ($cell_index_string =~ /,35,/)
	{
		$score++;
		$tissue_string .= "cerebellar,";
	}

# ---------------------------------------------------------------------------------------------------------------------------------------
# connective
# ---------------------------------------------------------------------------------------------------------------------------------------

	if ($cell_index_string =~ /,74,/)
	{
		$score++;
		$tissue_string .= "connective,";
	}

# ---------------------------------------------------------------------------------------------------------------------------------------
# embryonic lung
# ---------------------------------------------------------------------------------------------------------------------------------------

	if ($cell_index_string =~ /,120,|,121,/)
	{
		$score++;
		$tissue_string .= "embryonic_lung,";
	}

# ---------------------------------------------------------------------------------------------------------------------------------------
# epithelium
# ---------------------------------------------------------------------------------------------------------------------------------------

	if ($cell_index_string =~ /,34,|,42,|,45,|,50,|,62,|,66,|,67,|,68,|,70,|,106,|,109,|,111,/)
	{
		$score++;
		$tissue_string .= "epithelium,";
	}

# ---------------------------------------------------------------------------------------------------------------------------------------
# eye
# ---------------------------------------------------------------------------------------------------------------------------------------

	if ($cell_index_string =~ /,44,/)
	{
		$score++;
		$tissue_string .= "eye,";
	}

# ---------------------------------------------------------------------------------------------------------------------------------------
# fetal membrane
# ---------------------------------------------------------------------------------------------------------------------------------------

	if ($cell_index_string =~ /,17,/)
	{
		$score++;
		$tissue_string .= "fetal_membrane,";
	}

# ---------------------------------------------------------------------------------------------------------------------------------------
# foreskin
# ---------------------------------------------------------------------------------------------------------------------------------------

	if ($cell_index_string =~ /,47,|,48,/)
	{
		$score++;
		$tissue_string .= "foreskin,";
	}

# ---------------------------------------------------------------------------------------------------------------------------------------
# gingiva
# ---------------------------------------------------------------------------------------------------------------------------------------

	if ($cell_index_string =~ /,5,|,49,/)
	{
		$score++;
		$tissue_string .= "gingiva,";
	}

# ---------------------------------------------------------------------------------------------------------------------------------------
# heart
# ---------------------------------------------------------------------------------------------------------------------------------------

	if ($cell_index_string =~ /,39,|,40,|,41,/)
	{
		$score++;
		$tissue_string .= "heart,";
	}

# ---------------------------------------------------------------------------------------------------------------------------------------
# kidney
# ---------------------------------------------------------------------------------------------------------------------------------------

	if ($cell_index_string =~ /,69,/)
	{
		$score++;
		$tissue_string .= "kidney,";
	}

# ---------------------------------------------------------------------------------------------------------------------------------------
# liver
# ---------------------------------------------------------------------------------------------------------------------------------------

	if ($cell_index_string =~ /,78,|,81,|,82,|,115,/)
	{
		$score++;
		$tissue_string .= "liver,";
	}

# ---------------------------------------------------------------------------------------------------------------------------------------
# lung
# ---------------------------------------------------------------------------------------------------------------------------------------

	if ($cell_index_string =~ /,3,|,65,|,100,/)
	{
		$score++;
		$tissue_string .= "lung,";
	}

# ---------------------------------------------------------------------------------------------------------------------------------------
# mammary
# ---------------------------------------------------------------------------------------------------------------------------------------

	if ($cell_index_string =~ /,53,/)
	{
		$score++;
		$tissue_string .= "mammary,";
	}

# ---------------------------------------------------------------------------------------------------------------------------------------
# monocytes
# ---------------------------------------------------------------------------------------------------------------------------------------

	if ($cell_index_string =~ /,13,/)
	{
		$score++;
		$tissue_string .= "monocytes,";
	}

# ---------------------------------------------------------------------------------------------------------------------------------------
# muscle
# ---------------------------------------------------------------------------------------------------------------------------------------

	if ($cell_index_string =~ /,19,|,71,|,72,|,114,/)
	{
		$score++;
		$tissue_string .= "muscle,";
	}

# ---------------------------------------------------------------------------------------------------------------------------------------
# myometrium
# ---------------------------------------------------------------------------------------------------------------------------------------

	if ($cell_index_string =~ /,94,/)
	{
		$score++;
		$tissue_string .= "myometrium,";
	}

# ---------------------------------------------------------------------------------------------------------------------------------------
# pancreas
# ---------------------------------------------------------------------------------------------------------------------------------------

	if ($cell_index_string =~ /,104,|,105,/)
	{
		$score++;
		$tissue_string .= "pancreas,";
	}

# ---------------------------------------------------------------------------------------------------------------------------------------
# pancreatic_duct
# ---------------------------------------------------------------------------------------------------------------------------------------

	if ($cell_index_string =~ /,79,/)
	{
		$score++;
		$tissue_string .= "pancreatic_duct,";
	}


# ---------------------------------------------------------------------------------------------------------------------------------------
# prostate
# ---------------------------------------------------------------------------------------------------------------------------------------

	if ($cell_index_string =~ /,107,|,110,/)
	{
		$score++;
		$tissue_string .= "prostate,";
	}


# ---------------------------------------------------------------------------------------------------------------------------------------
# skin
# ---------------------------------------------------------------------------------------------------------------------------------------

	if ($cell_index_string =~ /,2,|,4,|,6,|,11,|,20,|,21,|,93,|,97,|,98,|,99,|,108,/)
	{
		$score++;
		$tissue_string .= "skin,";
	}

# ---------------------------------------------------------------------------------------------------------------------------------------
# spinal cord
# ---------------------------------------------------------------------------------------------------------------------------------------

	if ($cell_index_string =~ /,37,/)
	{
		$score++;
		$tissue_string .= "spinal_cord,";
	}

# ---------------------------------------------------------------------------------------------------------------------------------------
# urothelium
# ---------------------------------------------------------------------------------------------------------------------------------------

	if ($cell_index_string =~ /,117,|,118,/)
	{
		$score++;
		$tissue_string .= "urothelium,";
	}

# ---------------------------------------------------------------------------------------------------------------------------------------
# uterus
# ---------------------------------------------------------------------------------------------------------------------------------------

	if ($cell_index_string =~ /,84,|,85,/)
	{
		$score++;
		$tissue_string .= "uterus,";
	}

# ---------------------------------------------------------------------------------------------------------------------------------------
# Print the read to the output file
# ---------------------------------------------------------------------------------------------------------------------------------------

	if ($score > 0)
	{
		$output_counter++;
		print OUTPUT_FILE $line_array[0] . "\t" . $line_array[1] . "\t" . $line_array[2] . "\t" . $score . "\t" . $line_array[4] . "\t" . $line_array[5] . "\t" . $score . "\t" . $tissue_string . "\n";
	}


} # END: while ($line = <INPUT_FILE>)


# =======================================================================================================================================
# Finish up
# =======================================================================================================================================

close INPUT_FILE;
close OUTPUT_FILE;

print STDOUT "Read $line_counter entries\n";
print STDOUT "Printed $output_counter entries to $output_file_name\n";
